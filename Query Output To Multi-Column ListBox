' Title:        QueryOutputToListBox2
' Purpose:      Executes a query and outputs to contents of a multi-column (n=10) listbox
' Disclaimer:   Not plug-n-play. Must replace "***" with your database information.  Assumes DB fields are NOT NULL.
' Author:       Brian White
' Date:         September, 2014

Sub QueryOutputToListBox2()
Dim adoRecSet As New ADODB.Recordset
Dim connDB As New ADODB.Connection
Dim strConn, strSQL As String
Dim resultCount, n As Integer

Set connDB = New ADODB.Connection

' Replace asterisks with your SQL Query
strSQL = "***"

' Replace asterisks with your Database Connection Provider
connDB.Provider = "***"

' Replace asterisks with your Database Connection String Information
strConn = "Server=srv:***;data source=***;UID=***;PWD=***;Connect Timeout=10"

On Error Resume Next
connDB.Open strConn

' If the connection fails, a message box appears to notify the user.
If connDB.state <> adStateOpen Then

    MsgBox ("Couldn't connect to the database.  Check your connection settings.")
    Exit Sub
    
End If

Set adoRecSet = New ADODB.Recordset

On Error GoTo ErrorHandler1:
adoRecSet.Open Source:=strSQL, ActiveConnection:=connDB, CursorType:=adOpenStatic, LockType:=adLockOptimistic

resultCount = adoRecSet.RecordCount

If Not resultCount > 0 Then
    GoTo ErrorHandler2
End If

n = 0
adoRecSet.MoveFirst

Do
    With UserForm.listboxname
        .AddItem
        .List(n, 0) = adoRecSet.Fields(0).Value
        .List(n, 1) = adoRecSet.Fields(1).Value
        .List(n, 2) = adoRecSet.Fields(2).Value
        .List(n, 3) = adoRecSet.Fields(3).Value
        .List(n, 4) = adoRecSet.Fields(4).Value
        .List(n, 5) = adoRecSet.Fields(5).Value
        .List(n, 6) = adoRecSet.Fields(6).Value
        .List(n, 7) = adoRecSet.Fields(7).Value
        .List(n, 8) = adoRecSet.Fields(8).Value
        .List(n, 9) = adoRecSet.Fields(9).Value
    End With
    n = n + 1
    adoRecSet.MoveNext
Loop Until adoRecSet.EOF

' Close objects and release from memory
adoRecSet.Close
connDB.Close
Set adoRecSet = Nothing
Set connDB = Nothing

Exit Sub

' If there's an error with your SQL query..
ErrorHandler1:
    
    Set adoRecSet = Nothing
    
    MsgBox ("Query Failed")
    
    Exit Sub

' If your query returns 0 results...
ErrorHandler2:
    
    MsgBox "No Results"
    
    adoRecSet.Close
    connDB.Close
    
    Set adoRecSet = Nothing
    Set connDB = Nothing
    
End Sub
